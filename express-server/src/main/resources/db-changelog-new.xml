<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9 
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
   <changeSet author="adam (generated)" id="1">
      <createTable tableName="access_request">
         <column name="request_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="access_request_pkey"/>
         </column>
         <column name="reason" type="VARCHAR(255)"/>
         <column name="request_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="resolved_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="status" type="java.sql.Types.INTEGER"/>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
         <column name="project_id" type="java.sql.Types.BIGINT"/>
         <column name="user_id" type="java.sql.Types.BIGINT"/>
      </createTable>

      <createTable tableName="backlog">
         <column name="backlog_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="backlog_pkey"/>
         </column>
         <column name="as_a" type="VARCHAR(255)"/>
         <column name="business_value" type="java.sql.Types.INTEGER"/>
         <column name="description" type="java.sql.Types.CLOB"/>
         <column name="effort" type="java.sql.Types.INTEGER"/>
         <column name="reference" type="VARCHAR(255)"/>
         <column name="so_that" type="VARCHAR(255)"/>
         <column name="status" type="java.sql.Types.INTEGER"/>
         <column name="summary" type="VARCHAR(255)"/>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
         <column name="i_want" type="VARCHAR(255)"/>
         <column name="user_id" type="java.sql.Types.BIGINT"/>
         <column name="iteration_id" type="java.sql.Types.BIGINT"/>
         <column name="project_id" type="java.sql.Types.BIGINT"/>
         <column name="parent_id" type="java.sql.Types.BIGINT"/>
      </createTable>

      <createTable tableName="effort">
         <column name="effort_rec_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="effort_pkey"/>
         </column>
         <column name="record_date" type="java.sql.Types.DATE"/>
         <column name="remaining_effort" type="java.sql.Types.INTEGER"/>
         <column name="iteration_id" type="java.sql.Types.BIGINT"/>
      </createTable>

      <createTable tableName="express_user">
         <column name="user_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="express_user_pkey"/>
         </column>
         <column name="active" type="java.sql.Types.BOOLEAN"/>
         <column name="colour" type="java.sql.Types.INTEGER"/>
         <column name="created_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="email" type="VARCHAR(255)">
            <constraints nullable="false"/>
         </column>
         <column name="f_name" type="VARCHAR(255)"/>
         <column name="l_name" type="VARCHAR(255)"/>
         <column name="password" type="VARCHAR(255)"/>
         <column name="passwd_hint" type="VARCHAR(255)"/>
         <column name="phone1" type="VARCHAR(255)"/>
         <column name="phone2" type="VARCHAR(255)"/>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
      </createTable>

      <createTable tableName="iteration">
         <column name="iteration_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="iteration_pkey"/>
         </column>
         <column name="description" type="VARCHAR(255)"/>
         <column name="end_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="start_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="title" type="VARCHAR(255)"/>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
         <column name="project_id" type="java.sql.Types.BIGINT"/>
      </createTable>

      <createTable tableName="permissions">
         <column name="permissions_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="permissions_pkey"/>
         </column>
         <column name="iteration_admin" type="java.sql.Types.BOOLEAN"/>
         <column name="project_admin" type="java.sql.Types.BOOLEAN"/>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
      </createTable>

      <createTable tableName="project">
         <column name="project_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="project_pkey"/>
         </column>
         <column name="description" type="VARCHAR(255)"/>
         <column name="reference" type="VARCHAR(255)"/>
         <column name="start_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="title" type="VARCHAR(255)"/>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
         <column name="effort_unit" type="VARCHAR(255)"/>
      </createTable>

      <createTable tableName="project_worker">
         <column name="worker_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="project_worker_pkey"/>
         </column>
         <column name="created_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
         <column name="permissions_id" type="java.sql.Types.BIGINT"/>
         <column name="user_id" type="java.sql.Types.BIGINT"/>
         <column name="project_id" type="java.sql.Types.BIGINT"/>
      </createTable>

      <createTable tableName="sequence_list">
         <column name="name" type="VARCHAR(255)"/>
         <column name="next_value" type="java.sql.Types.INTEGER"/>
      </createTable>

      <createIndex indexName="express_user_email_key" tableName="express_user" unique="true">
         <column name="email"/>
      </createIndex>

      <addForeignKeyConstraint baseColumnNames="project_id" baseTableName="access_request"
                               constraintName="fk29672a94989c091b" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="project_id"
                               referencedTableName="project"/>
      <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="access_request"
                               constraintName="fk29672a9472ebe779" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="user_id"
                               referencedTableName="express_user"/>
      <addForeignKeyConstraint baseColumnNames="iteration_id" baseTableName="backlog"
                               constraintName="fk1619acdd7d2fc65b" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="iteration_id"
                               referencedTableName="iteration"/>
      <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="backlog"
                               constraintName="fk1619acdd5c1d2c01" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="backlog_id"
                               referencedTableName="backlog"/>
      <addForeignKeyConstraint baseColumnNames="project_id" baseTableName="backlog"
                               constraintName="fk1619acdd989c091b" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="project_id"
                               referencedTableName="project"/>
      <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="backlog"
                               constraintName="fk1619acdd72ebe779" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="user_id"
                               referencedTableName="express_user"/>
      <addForeignKeyConstraint baseColumnNames="iteration_id" baseTableName="effort"
                               constraintName="fk79b9d4ec7d2fc65b" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="iteration_id"
                               referencedTableName="iteration"/>
      <addForeignKeyConstraint baseColumnNames="project_id" baseTableName="iteration"
                               constraintName="fk2f1cfebd989c091b" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="project_id"
                               referencedTableName="project"/>
      <addForeignKeyConstraint baseColumnNames="permissions_id" baseTableName="project_worker"
                               constraintName="fk5b315384695124bb" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="permissions_id"
                               referencedTableName="permissions"/>
      <addForeignKeyConstraint baseColumnNames="project_id" baseTableName="project_worker"
                               constraintName="fk5b315384989c091b" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="project_id"
                               referencedTableName="project"/>
      <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="project_worker"
                               constraintName="fk5b31538472ebe779" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="user_id"
                               referencedTableName="express_user"/>
   </changeSet>

   <changeSet id="2" author="adam">
      <addColumn tableName="backlog">
         <column name="title" type="VARCHAR(255)"/>
      </addColumn>
   </changeSet>

   <changeSet id="3" author="adam">
      <createTable tableName="theme">
         <column name="theme_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="theme_pkey"/>
         </column>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
         <column name="title" type="VARCHAR(255)"/>
         <column name="description" type="VARCHAR(255)"/>
         <column name="project_id" type="java.sql.Types.BIGINT"/>
      </createTable>

      <createTable tableName="backlog_theme">
         <column name="backlog_id" type="java.sql.Types.BIGINT"/>
         <column name="theme_id" type="java.sql.Types.BIGINT"/>
      </createTable>

      <addForeignKeyConstraint baseColumnNames="project_id" baseTableName="theme"
                               constraintName="theme_project_fk" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="project_id"
                               referencedTableName="project"/>
      <addForeignKeyConstraint baseColumnNames="backlog_id" baseTableName="backlog_theme"
                               constraintName="theme_backlog_fk" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="backlog_id"
                               referencedTableName="backlog"/>
      <addForeignKeyConstraint baseColumnNames="theme_id" baseTableName="backlog_theme"
                               constraintName="backlog_theme_fk" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="theme_id"
                               referencedTableName="theme"/>
   </changeSet>

   <changeSet id="4" author="adam">
      <createTable tableName="criteria">
         <column name="criteria_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="criteria_pkey"/>
         </column>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
         <column name="reference" type="VARCHAR(255)"/>
         <column name="title" type="VARCHAR(255)"/>
         <column name="description" type="VARCHAR(255)"/>
         <column name="verified" type="java.sql.Types.BOOLEAN"/>
         <column name="backlog_id" type="java.sql.Types.BIGINT"/>
      </createTable>
      <addForeignKeyConstraint baseColumnNames="backlog_id" baseTableName="criteria"
                               constraintName="criteria_backlog_fk" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="backlog_id"
                               referencedTableName="backlog"/>
   </changeSet>
   <changeSet id="5" author="adam">
      <addColumn tableName="iteration">
         <column name="final_velocity" type="java.sql.Types.INTEGER"/>
      </addColumn>
   </changeSet>

    <changeSet id="6" author="adam">
      <addColumn tableName="backlog">
         <column name="final_velocity" type="java.sql.Types.INTEGER"/>
      </addColumn>
   </changeSet>

   <changeSet id="7" author="adam">

      <createTable tableName="issue">
         <column name="issue_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="issue_pkey"/>
         </column>
         <column name="title" type="VARCHAR(255)"/>
         <column name="description" type="java.sql.Types.CLOB"/>
         <column name="end_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="start_date" type="java.sql.Types.TIMESTAMP"/>
         <column name="iteration_id" type="java.sql.Types.BIGINT"/>
         <column name="user_id" type="java.sql.Types.BIGINT"/>
         <column name="version_no" type="java.sql.Types.BIGINT"/>
      </createTable>

      <addColumn tableName="backlog">
         <column name="impediment_id" type="java.sql.Types.BIGINT"/>
      </addColumn>

      <addForeignKeyConstraint baseColumnNames="impediment_id" baseTableName="backlog"
                               constraintName="fk_issue_backlog" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="issue_id"
                               referencedTableName="issue"/>
      <addForeignKeyConstraint baseColumnNames="iteration_id" baseTableName="issue"
                               constraintName="fk_iteration_issue" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="iteration_id"
                               referencedTableName="iteration"/>
      <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="issue"
                               constraintName="fk_user_issue" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="user_id"
                               referencedTableName="express_user"/>
   </changeSet>

   <changeSet id="8" author="adam">
      <addColumn tableName="project">
         <column name="story_count" type="java.sql.Types.INTEGER" defaultValue="0"/>
      </addColumn>
      <addColumn tableName="backlog">
         <column name="task_count" type="java.sql.Types.INTEGER" defaultValue="0"/>
      </addColumn>
   </changeSet>

   <changeSet id="9" author="adam">
      <createTable tableName="project_history">
         <column name="project_status_id" type="java.sql.Types.BIGINT">
            <constraints nullable="false" primaryKey="true" primaryKeyName="project_status_pkey"/>
         </column>
         <column name="record_date" type="java.sql.Types.DATE"/>
         <column name="points_total" type="java.sql.Types.INTEGER"/>
         <column name="points_completed" type="java.sql.Types.INTEGER"/>
         <column name="project_id" type="java.sql.Types.BIGINT"/>
      </createTable>

      <addForeignKeyConstraint baseColumnNames="project_id" baseTableName="project_history"
                               constraintName="fk_proj_proj_status" deferrable="false"
                               initiallyDeferred="false" referencedColumnNames="project_id"
                               referencedTableName="project"/>
      <renameTable oldTableName="effort" newTableName="iteration_history"/>

      <addColumn tableName="iteration_history">
         <column name="points_total" type="java.sql.Types.INTEGER" />
      </addColumn>
      <addColumn tableName="iteration_history">
         <column name="points_completed" type="java.sql.Types.INTEGER" />
      </addColumn>
      <addColumn tableName="iteration">
         <column name="goal" type="java.sql.Types.CLOB"/>
      </addColumn>
      <sql>
         update iteration set goal = description
      </sql>
      <dropColumn tableName="iteration" columnName="description"/>
   </changeSet>
   <changeSet id="10" author="adam">
      <modifyColumn tableName="project">
         <column name="description" type="java.sql.Types.CLOB"/>
      </modifyColumn>
   </changeSet>

</databaseChangeLog>
